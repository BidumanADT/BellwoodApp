# Location Picker Service Documentation

## Overview

The **Location Picker Service** is a cross-platform, modular solution for selecting locations in the Bellwood Elite mobile app. 
It integrates with native maps applications (Google Maps, Apple Maps, Bing Maps) to provide a seamless location selection experience across Android, iOS, macOS, and Windows.

## Architecture

```
???????????????????????????????????????????????????????????????????
?                     Location Picker System                       ?
???????????????????????????????????????????????????????????????????
?                                                                  ?
?  ????????????????????    ????????????????????????????????????  ?
?  ?  ILocationPicker ?    ?        LocationPickerService      ?  ?
?  ?     Service      ??????  (Cross-platform implementation) ?  ?
?  ????????????????????    ????????????????????????????????????  ?
?           ?                           ?                         ?
?           ?                           ?                         ?
?           ?              ????????????????????????????????????  ?
?           ?              ?     Platform-Specific APIs        ?  ?
?           ?              ????????????????????????????????????  ?
?           ?              ? • IGeolocation (GPS)              ?  ?
?           ?              ? • IGeocoding (Address?Coords)     ?  ?
?           ?              ? • IMap (Native map launcher)      ?  ?
?           ?              ? • ILauncher (URL schemes)         ?  ?
?           ?              ????????????????????????????????????  ?
?           ?                                                     ?
?           ?                                                     ?
?  ????????????????????????????????????????????????????????????  ?
?  ?                    Consumer Pages                         ?  ?
?  ????????????????????????????????????????????????????????????  ?
?  ?  • QuotePage          (Pickup/Dropoff selection)         ?  ?
?  ?  • BookRidePage       (Pickup/Dropoff selection)         ?  ?
?  ?  • Future: ManageLocationsPage, etc.                     ?  ?
?  ????????????????????????????????????????????????????????????  ?
?                                                                  ?
???????????????????????????????????????????????????????????????????
```

## Components

### 1. Location Model (`Models/Location.cs`)

Enhanced location model with coordinates support:

```csharp
public class Location
{
    public string Id { get; set; }           // Unique GUID
    public string Label { get; set; }        // User-friendly name (e.g., "Home")
    public string Address { get; set; }      // Full street address
    public double? Latitude { get; set; }    // GPS latitude
    public double? Longitude { get; set; }   // GPS longitude
    public string? PlaceId { get; set; }     // Optional mapping service ID
    public bool IsVerified { get; set; }     // True if geocoded/verified
    public bool IsFavorite { get; set; }     // User favorite flag
    public DateTime? LastUpdatedUtc { get; set; }
    public int UseCount { get; set; }        // Usage frequency tracking
    
    // Computed properties
    public bool HasCoordinates { get; }
    public (double Lat, double Lng)? Coordinates { get; }
}
```

### 2. Location Picker Service Interface (`Services/ILocationPickerService.cs`)

```csharp
public interface ILocationPickerService
{
    // Core picking functionality
    Task<LocationPickerResult> PickLocationAsync(LocationPickerOptions? options = null, CancellationToken ct = default);
    
    // Maps integration
    Task OpenInMapsAsync(AppLocation location, CancellationToken ct = default);
    Task OpenDirectionsAsync(AppLocation? from, AppLocation to, CancellationToken ct = default);
    
    // Location services
    Task<AppLocation?> GetCurrentLocationAsync(CancellationToken ct = default);
    Task<AppLocation?> GeocodeAddressAsync(string address, CancellationToken ct = default);
    Task<AppLocation?> ReverseGeocodeAsync(double latitude, double longitude, CancellationToken ct = default);
    
    // Capability checks
    bool IsMapIntegrationAvailable { get; }
    Task<bool> IsLocationAvailableAsync();
}
```

### 3. Supporting Types

#### LocationPickerResult
```csharp
public sealed class LocationPickerResult
{
    public bool Success { get; init; }
    public AppLocation? Location { get; init; }
    public string? ErrorMessage { get; init; }
    public bool WasCancelled { get; init; }
}
```

#### LocationPickerOptions
```csharp
public sealed class LocationPickerOptions
{
    public AppLocation? InitialLocation { get; init; }
    public string? InitialAddress { get; init; }
    public string? SuggestedLabel { get; init; }
    public bool UseCurrentLocation { get; init; } = true;
    public string Title { get; init; } = "Select Location";
    public bool AllowSearch { get; init; } = true;
    public bool GeocodeAddress { get; init; } = true;
}
```

## Platform Support

| Platform | Native Maps App | Deep Link Scheme | Fallback |
|----------|----------------|------------------|----------|
| Android | Google Maps | `geo:` / `google.navigation:` | Web Google Maps |
| iOS | Apple Maps | `maps://` | Web Google Maps |
| macOS | Apple Maps | `maps://` | Web Google Maps |
| Windows | Bing Maps | `bingmaps:` | Web Google Maps |

## Usage Examples

### Basic Location Picking

```csharp
// Inject the service
private readonly ILocationPickerService _locationPicker;

// Pick a location with default options
var result = await _locationPicker.PickLocationAsync();

if (result.Success && result.Location is not null)
{
    Console.WriteLine($"Selected: {result.Location.Label} - {result.Location.Address}");
    
    if (result.Location.HasCoordinates)
        Console.WriteLine($"Coordinates: {result.Location.Latitude}, {result.Location.Longitude}");
}
```

### Picking with Custom Options

```csharp
var result = await _locationPicker.PickLocationAsync(new LocationPickerOptions
{
    Title = "Select Pickup Location",
    SuggestedLabel = "Airport Terminal",
    InitialAddress = "O'Hare International Airport",
    UseCurrentLocation = true,  // Start with user's location if available
    GeocodeAddress = true       // Automatically get coordinates
});
```

### Opening Directions

```csharp
var pickup = new Location 
{ 
    Address = "123 Main St, Chicago, IL",
    Latitude = 41.8781,
    Longitude = -87.6298
};

var dropoff = new Location
{
    Address = "O'Hare International Airport",
    Latitude = 41.9742,
    Longitude = -87.9073
};

// Open native maps with directions
await _locationPicker.OpenDirectionsAsync(pickup, dropoff);
```

### Getting Current Location

```csharp
var currentLocation = await _locationPicker.GetCurrentLocationAsync();

if (currentLocation is not null)
{
    Console.WriteLine($"You are at: {currentLocation.Address}");
    Console.WriteLine($"Coords: {currentLocation.Latitude}, {currentLocation.Longitude}");
}
```

### Geocoding an Address

```csharp
var location = await _locationPicker.GeocodeAddressAsync("Willis Tower, Chicago");

if (location?.HasCoordinates == true)
{
    Console.WriteLine($"Willis Tower is at: {location.Latitude}, {location.Longitude}");
}
```

## Integration in Pages

### QuotePage Integration

The QuotePage uses the location picker for both pickup and dropoff locations:

```csharp
private async void OnPickPickupFromMaps(object? sender, EventArgs e)
{
    var result = await _locationPicker.PickLocationAsync(new LocationPickerOptions
    {
        Title = "Select Pickup Location",
        SuggestedLabel = (PickupNewLabel.Text ?? "").Trim(),
        InitialAddress = (PickupNewAddress.Text ?? "").Trim(),
        UseCurrentLocation = true
    });

    if (result.Success && result.Location is not null)
    {
        PickupNewLabel.Text = result.Location.Label;
        PickupNewAddress.Text = result.Location.Address;
    }
    else if (!result.WasCancelled && !string.IsNullOrEmpty(result.ErrorMessage))
    {
        await DisplayAlert("Location Error", result.ErrorMessage, "OK");
    }
}
```

### XAML Button Integration

```xml
<Button Text="??? Pick from Maps" 
        Clicked="OnPickPickupFromMaps" 
        BackgroundColor="{StaticResource BellwoodCharcoal}" 
        TextColor="{StaticResource BellwoodGold}" 
        BorderColor="{StaticResource BellwoodGold}" 
        BorderWidth="1" />
```

## User Experience Flow

```
???????????????????????????????????????????????????????????????????
?                    User Selects "New Location"                   ?
???????????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????????
?                  User Taps "??? Pick from Maps"                  ?
???????????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????????
?                    Action Sheet Appears:                         ?
?  ???????????????????????????????????????????????????????????   ?
?  ?  ?? Enter Address Manually                               ?   ?
?  ?  ??? Open Maps App                                        ?   ?
?  ?  ?? Use Current Location                                 ?   ?
?  ?  ? Use: [existing address if any]                       ?   ?
?  ?  Cancel                                                  ?   ?
?  ???????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????????
                              ?
          ?????????????????????????????????????????
          ?                   ?                   ?
          ?                   ?                   ?
???????????????????  ???????????????????  ???????????????????
? Manual Entry    ?  ? Opens Native    ?  ? Gets GPS        ?
? - Address       ?  ? Maps App        ?  ? Coordinates     ?
? - Label         ?  ? - User browses  ?  ? - Reverse       ?
? - Geocode       ?  ? - Returns to    ?  ?   geocodes      ?
?                 ?  ?   app           ?  ? - Prompts for   ?
?                 ?  ? - Enters addr   ?  ?   label         ?
???????????????????  ???????????????????  ???????????????????
          ?                   ?                   ?
          ?????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????????
?              Location Returned with Coordinates                  ?
?  - Label: "Home"                                                ?
?  - Address: "123 Main St, Chicago, IL 60601"                    ?
?  - Latitude: 41.8781                                            ?
?  - Longitude: -87.6298                                          ?
?  - IsVerified: true                                             ?
???????????????????????????????????????????????????????????????????
```

## Dependency Injection Setup

The service is registered in `MauiProgram.cs`:

```csharp
// In MauiProgram.CreateMauiApp()
builder.Services.AddSingleton<ILocationPickerService, LocationPickerService>();
```

## Permissions

### Android (`AndroidManifest.xml`)

```xml
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
```

### iOS (`Info.plist`)

```xml
<key>NSLocationWhenInUseUsageDescription</key>
<string>We need your location to help you select pickup and dropoff addresses.</string>
```

The service automatically handles permission requests at runtime.

## Error Handling

The service handles common error scenarios gracefully:

| Error Type | Handling |
|------------|----------|
| Permission denied | Returns `LocationPickerResult.Failed()` with user-friendly message |
| Location not available | Falls back to manual entry |
| Geocoding failure | Location returned without coordinates |
| Map app not installed | Falls back to web-based Google Maps |
| Network unavailable | Uses cached location if available |

## Caching

The service includes a 2-minute cache for current location to reduce battery usage:

```csharp
private static readonly TimeSpan LocationCacheExpiry = TimeSpan.FromMinutes(2);
```

## Future Enhancements

1. **Search Autocomplete** - Integrate Google Places API or Apple MapKit for address suggestions
2. **Recent Locations** - Track and suggest recently used locations
3. **Favorites Management** - UI for managing favorite locations
4. **Offline Support** - Cache frequently used location coordinates
5. **Map Preview** - In-app map view for location confirmation

## Files Modified/Created

| File | Change |
|------|--------|
| `Models/Location.cs` | Enhanced with coordinates, favorites, timestamps |
| `Services/ILocationPickerService.cs` | **NEW** - Interface definition |
| `Services/LocationPickerService.cs` | **NEW** - Cross-platform implementation |
| `Services/IProfileService.cs` | Added location CRUD methods |
| `Services/ProfileService.cs` | Implemented location management |
| `Core/Domain/Passenger.cs` | Added Id property |
| `MauiProgram.cs` | Registered LocationPickerService |
| `Pages/QuotePage.xaml` | Added "Pick from Maps" buttons |
| `Pages/QuotePage.xaml.cs` | Added map picker event handlers |
| `Pages/BookRidePage.xaml` | Added "Pick from Maps" buttons |
| `Pages/BookRidePage.xaml.cs` | Added map picker event handlers |
